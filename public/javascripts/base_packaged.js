(function($){$.fn.tokenInput=function(url,options){var settings=$.extend({url:url,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",createText:"Create",searchDelay:300,allowNewValues:false,initialValues:null,defaultOptions:null,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",onResult:null,canCreate:false,forceLowerCase:false,createIdentifier:""},options);settings.classes=$.extend({tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},options.classes);return this.each(function(){var list=new $.TokenList(this,settings);});};$.TokenList=function(input,settings){var POSITION={BEFORE:0,AFTER:1,END:2};var KEY={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188};var saved_tokens=[];var token_count=0;var cache=new $.TokenList.Cache();var timeout;var show_dropdown=false,hide_dropdown_timeout=null,show_dropdown_timeout=null;var input_box=$("<input type=\"text\">").css({outline:"none"}).focus(function(){if(settings.tokenLimit==null||settings.tokenLimit!=token_count){window.clearTimeout(hide_dropdown_timeout);setTimeout(function(){show_dropdown_hint(),200});}}).blur(function(){if(settings.allowNewValues)create_new_token();if(settings.defaultOptions){hide_dropdown_timeout=setTimeout(function(){hide_dropdown();},200);}
else{hide_dropdown();}}).keydown(function(event){var previous_token;var next_token;switch(event.keyCode){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:if(!$(this).val()){previous_token=input_token.prev();next_token=input_token.next();if((previous_token.length&&previous_token.get(0)===selected_token)||(next_token.length&&next_token.get(0)===selected_token)){if(event.keyCode==KEY.LEFT||event.keyCode==KEY.UP){deselect_token($(selected_token),POSITION.BEFORE);}else{deselect_token($(selected_token),POSITION.AFTER);}}else if((event.keyCode==KEY.LEFT||event.keyCode==KEY.UP)&&previous_token.length){select_token($(previous_token.get(0)));}else if((event.keyCode==KEY.RIGHT||event.keyCode==KEY.DOWN)&&next_token.length){select_token($(next_token.get(0)));}}else{var dropdown_item=null;if(event.keyCode==KEY.DOWN||event.keyCode==KEY.RIGHT){dropdown_item=$(selected_dropdown_item).next();}else{dropdown_item=$(selected_dropdown_item).prev();}
if(dropdown_item.length){select_dropdown_item(dropdown_item);}
return false;}
break;case KEY.BACKSPACE:previous_token=input_token.prev();if(!$(this).val().length){if(selected_token){delete_token($(selected_token));}else if(previous_token.length){select_token($(previous_token.get(0)));}
return false;}else if($(this).val().length==1){hide_dropdown();}else{setTimeout(function(){do_search(false);},5);}
break;case KEY.TAB:if(selected_dropdown_item){add_token($(selected_dropdown_item));return false;}else if(settings.allowNewValues){create_new_token();return false;}
break;case KEY.RETURN:case KEY.COMMA:if(selected_dropdown_item){add_token($(selected_dropdown_item));return false;}else if(settings.allowNewValues){create_new_token();return false;}
break;case KEY.ESC:hide_dropdown();return true;default:if(is_printable_character(event.keyCode)){setTimeout(function(){do_search(false);},5);}
break;}
return true;});var hidden_input=$(input).hide().focus(function(){input_box.focus();}).blur(function(){input_box.blur();});var selected_token=null;var selected_dropdown_item=null;var token_list=$("<ul />").addClass(settings.classes.tokenList).insertAfter(hidden_input).click(function(event){var li=get_element_from_event(event,"li."+settings.classes.token);if(li&&li.get(0)!=input_token.get(0)){toggle_select_token(li);return false;}else{input_box.focus();if(selected_token){deselect_token($(selected_token),POSITION.END);}}
return true;}).mouseover(function(event){var li=get_element_from_event(event,"li");if(li&&selected_token!==this){li.addClass(settings.classes.highlightedToken);}}).mouseout(function(event){var li=get_element_from_event(event,"li");if(li&&selected_token!==this){li.removeClass(settings.classes.highlightedToken);}}).mousedown(function(event){var li=get_element_from_event(event,"li");if(li){return false;}
return true;});var dropdown=$("<div>").addClass(settings.classes.dropdown).insertAfter(token_list).hide();var input_token=$("<li />").addClass(settings.classes.inputToken).appendTo(token_list).append(input_box);init_list();function init_list(){if(settings.initialValues){hidden_input.val('');$.each(settings.initialValues,function(){create_token(this);});}else{hidden_input.val('');}}
function init_default_options(){if(settings.defaultOptions){populate_dropdown("",settings.defaultOptions);}}
function is_printable_character(keycode){if((keycode>=48&&keycode<=90)||(keycode>=96&&keycode<=111)||(keycode>=186&&keycode<=192)||(keycode>=219&&keycode<=222)){return true;}else{return false;}}
function get_element_from_event(event,element_type){var target=$(event.target);var element=null;if(target.is(element_type)){element=target;}else if(target.parent(element_type).length){element=target.parent(element_type+":first");}
return element;}
function insert_token(id,value){var this_token=$("<li><p>"+value+"</p> </li>").addClass(settings.classes.token).insertBefore(input_token);$("<span>x</span>").addClass(settings.classes.tokenDelete).appendTo(this_token).click(function(){delete_token($(this).parent());return false;});$.data(this_token.get(0),"tokeninput",{"id":id,"name":value});return this_token;}
function add_token(item){var li_data=$.data(item.get(0),"tokeninput");create_token(li_data);}
function create_token(li_data){var this_token=insert_token(li_data.id,li_data.name);input_box.val("").focus();hide_dropdown();var current_value=hidden_input.val();current_value=(current_value=="")?current_value:(current_value+",")
hidden_input.val(current_value+li_data.id);token_count++;if(settings.tokenLimit!=null&&settings.tokenLimit>=token_count){input_box.hide();hide_dropdown();}
$(hidden_input).trigger('tokenadd',{update:update_token,remove:delete_token,data:li_data,token:this_token.get(0)});}
function update_token(item,data){var old_data=$.data(item,"tokeninput");var new_data={id:data.id==undefined?old_data.id:data.id,name:data.name==undefined?old_data.name:data.name};$.data(item,"tokeninput",data);var old_id_string=old_data.id+",";var new_id_string=new_data.id+",";hidden_input.val(hidden_input.val().replace(old_id_string,new_id_string));}
function create_new_token(){return;var string=input_box.val().toLowerCase();if(string.length>0){var this_token=$("<li><p>"+string+"</p> </li>").addClass(settings.classes.token).insertBefore(input_token);$("<span>x</span>").addClass(settings.classes.tokenDelete).appendTo(this_token).click(function(){delete_token($(this).parent());return false;});add_token(this_token);}}
function select_token(token){token.addClass(settings.classes.selectedToken);selected_token=token.get(0);input_box.val("");hide_dropdown();}
function deselect_token(token,position){token.removeClass(settings.classes.selectedToken);selected_token=null;if(position==POSITION.BEFORE){input_token.insertBefore(token);}else if(position==POSITION.AFTER){input_token.insertAfter(token);}else{input_token.appendTo(token_list);}
input_box.focus();}
function toggle_select_token(token){if(selected_token==token.get(0)){deselect_token(token,POSITION.END);}else{if(selected_token){deselect_token($(selected_token),POSITION.END);}
select_token(token);}}
function delete_token(token){var token_data=$.data(token.get(0),"tokeninput");token.remove();selected_token=null;input_box.focus();var tokens=hidden_input.val().split(",");var to_delete=jQuery.inArray(token_data.id,tokens);tokens.splice(to_delete,1);hidden_input.val(tokens.join(","));token_count--;if(settings.tokenLimit!=null){input_box.show().val("").focus();}
$(hidden_input).trigger('tokendelete',{add:create_token,data:token_data});}
function hide_dropdown(){if(!show_dropdown){dropdown.hide().empty();selected_dropdown_item=null;}else{show_dropdown=false}}
function show_dropdown_searching(){if(settings.searchingText.length>0){dropdown.html("<p>"+settings.searchingText+"</p>").show();}}
function show_dropdown_hint(){if(settings.tokenLimit==null||(settings.tokenLimit>token_count)){dropdown.html("<p>"+settings.hintText+"</p>").show();if(settings.defaultOptions){dropdown.find("a.defaultOptions").click(function(event){show_dropdown=true;populate_dropdown("",settings.defaultOptions);return false;});}}else{hide_dropdown();}}
function highlight_term(value,term){return value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+term+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>");}
function populate_dropdown(query,results){if(results.length||settings.canCreate){dropdown.empty();var dropdown_ul=$("<ul>").appendTo(dropdown).mouseover(function(event){select_dropdown_item(get_element_from_event(event,"li"));}).click(function(event){add_token(get_element_from_event(event,"li"));}).mousedown(function(event){add_token(get_element_from_event(event,"li"));return false;}).hide();var resultAdded=new Array();$("."+settings.classes.token,token_list).each(function(i,val){var data=$.data(val,"tokeninput");resultAdded[data.name]=1;});var firstLi;for(var i in results){if(results.hasOwnProperty(i)&&!resultAdded[results[i].name]){var this_li=$("<li>"+highlight_term(results[i].name,query)+"</li>").appendTo(dropdown_ul);if(i%2){this_li.addClass(settings.classes.dropdownItem);}else{this_li.addClass(settings.classes.dropdownItem2);}
if(i==0){firstLi=this_li;}
resultAdded[results[i].name]=1;$.data(this_li.get(0),"tokeninput",{"id":results[i].id,"name":results[i].name});}}
if(settings.canCreate&&!resultAdded[query]){var li=$("<li>"+settings.createText+" '"+query+"'</li>").appendTo(dropdown_ul);if(results.length%2){li.addClass(settings.classes.dropdownItem);}else{li.addClass(settings.classes.dropdownItem2);}
if(results.length==0){firstLi=li;}
$.data(li.get(0),"tokeninput",{"id":settings.createIdentifier+query,"name":query});}
if(firstLi){select_dropdown_item(firstLi);}
dropdown.show();dropdown_ul.show();}else{if(settings.noResultsText.length>0){dropdown.html("<p>"+settings.noResultsText+"</p>").show();if(settings.defaultOptions){dropdown.find("a.defaultOptions").click(function(event){show_dropdown=true;populate_dropdown("",settings.defaultOptions);});}}else{hide_dropdown();}}}
function select_dropdown_item(item){if(item){if(selected_dropdown_item){deselect_dropdown_item($(selected_dropdown_item));}
item.addClass(settings.classes.selectedDropdownItem);selected_dropdown_item=item.get(0);}}
function deselect_dropdown_item(item){item.removeClass(settings.classes.selectedDropdownItem);selected_dropdown_item=null;}
function do_search(immediate){var query=input_box.val();if(settings.forceLowerCase){query=query.toLowerCase();}
if(query&&query.length){if(selected_token){deselect_token($(selected_token),POSITION.AFTER);}
if(query.length>=settings.minChars){show_dropdown_searching();if(immediate){run_search(query);}else{clearTimeout(timeout);timeout=setTimeout(function(){run_search(query);},settings.searchDelay);}}else{hide_dropdown();}}}
function run_search(query){var cached_results=cache.get(query);if(cached_results){populate_dropdown(query,cached_results);}else{var queryStringDelimiter=settings.url.indexOf("?")<0?"?":"&";var callback=function(results){if($.isFunction(settings.onResult)){results=settings.onResult.call(this,results);}
cache.add(query,settings.jsonContainer?results[settings.jsonContainer]:results);populate_dropdown(query,settings.jsonContainer?results[settings.jsonContainer]:results);};if(settings.method=="POST"){$.post(settings.url+queryStringDelimiter+settings.queryParam+"="+query,{},callback,settings.contentType);}else{$.get(settings.url+queryStringDelimiter+settings.queryParam+"="+query,{},callback,settings.contentType);}}}};$.TokenList.Cache=function(options){var settings=$.extend({max_size:50},options);var data={};var size=0;var flush=function(){data={};size=0;};this.add=function(query,results){if(size>settings.max_size){flush();}
if(!data[query]){size++;}
data[query]=results;};this.get=function(query){return data[query];};};})(jQuery);jQuery(function($){var csrf_token=$('meta[name=csrf-token]').attr('content'),csrf_param=$('meta[name=csrf-param]').attr('content');$.fn.extend({triggerAndReturn:function(name,data){var event=new $.Event(name);this.trigger(event,data);return event.result!==false;},callRemote:function(){var el=this,method=el.attr('method')||el.attr('data-method')||'GET',url=el.attr('action')||el.attr('href'),dataType=el.attr('data-type')||($.ajaxSettings&&$.ajaxSettings.dataType);if(url===undefined){throw"No URL specified for remote call (action or href must be present).";}else{if(el.triggerAndReturn('ajax:before')){var data=el.is('form')?el.serializeArray():[];$.ajax({url:url,data:data,dataType:dataType,type:method.toUpperCase(),beforeSend:function(xhr){xhr.setRequestHeader("Accept","text/javascript");el.trigger('ajax:loading',xhr);},success:function(data,status,xhr){el.trigger('ajax:success',[data,status,xhr]);},complete:function(xhr){el.trigger('ajax:complete',xhr);},error:function(xhr,status,error){el.trigger('ajax:failure',[xhr,status,error]);}});}
el.trigger('ajax:after');}}});$('body').delegate('a[data-confirm], button[data-confirm], input[data-confirm]','click.rails',function(){var el=$(this);if(el.triggerAndReturn('confirm')){if(!confirm(el.attr('data-confirm'))){return false;}}});$('form[data-remote]').live('submit.rails',function(e){$(this).callRemote();e.preventDefault();});$('a[data-remote],input[data-remote]').live('click.rails',function(e){$(this).callRemote();e.preventDefault();});$('a[data-method]:not([data-remote])').live('click.rails',function(e){var link=$(this),href=link.attr('href'),method=link.attr('data-method'),form=$('<form method="post" action="'+href+'"></form>'),metadata_input='<input name="_method" value="'+method+'" type="hidden" />';if(csrf_param!==undefined&&csrf_token!==undefined){metadata_input+='<input name="'+csrf_param+'" value="'+csrf_token+'" type="hidden" />';}
form.hide().append(metadata_input).appendTo('body');e.preventDefault();form.submit();});var disable_with_input_selector='input[data-disable-with]',disable_with_form_remote_selector='form[data-remote]:has('+disable_with_input_selector+')',disable_with_form_not_remote_selector='form:not([data-remote]):has('+disable_with_input_selector+')';var disable_with_input_function=function(){$(this).find(disable_with_input_selector).each(function(){var input=$(this);input.data('enable-with',input.val()).attr('value',input.attr('data-disable-with')).attr('disabled','disabled');});};$(disable_with_form_remote_selector).live('ajax:before.rails',disable_with_input_function);$(disable_with_form_not_remote_selector).live('submit.rails',disable_with_input_function);$(disable_with_form_remote_selector).live('ajax:complete.rails',function(){$(this).find(disable_with_input_selector).each(function(){var input=$(this);input.removeAttr('disabled').val(input.data('enable-with'));});});var jqueryVersion=$().jquery;if(!((jqueryVersion==='1.4.3')||(jqueryVersion==='1.4.4'))){alert('This rails.js does not support the jQuery version you are using. Please read documentation.');}});$(function(){$("#sorting .change_sorting").click(function(){$('#sorting .options').toggle();if($(this).hasClass("active")){$(this).removeClass("active");}else{$(this).addClass("active");}});$("#s").focus(function(e){toggleLabel(this,false);}).blur(function(e){toggleLabel(this,true);});});function toggleLabel(element,show){var label=$(element).parent().find("label");show&&$(element).val()==''?$(label).show():$(label).hide();}